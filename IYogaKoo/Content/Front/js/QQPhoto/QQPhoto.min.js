/**
 * QQ.Photo 1.1.0
 * Date: 2014-06-15
 * (c) 2014-2014 M.J, http://webjyh.com
 *
 * This is licensed under the GNU LGPL, version 2.1 or later.
 * For details, see: http://creativecommons.org/licenses/LGPL/2.1/
 *
 */
(function (b) {
    var a = function (d, c) {
        var e = this;
        this.elem = b(d);
        this.options = c;
        this.index = null;
        this.thumbNum = 0;
        this.listWidth = 0;
        this.liWidth = 0;
        this.len = 0;
        this.thumbList = [];
        this.ulElem = {};
        this.IE6 = !-[1] && !window.XMLHttpRequest;
        this.image = [];
        this.elem.bind("click",
        function (f) {
            var imgid = f.currentTarget.id;
            f.preventDefault();
            e.init(imgid);
            return false
        })
    };
    a.prototype = {
        defaults: {
            url: "data.json",
            commentURL: "comment.json",
            fix: 5,
            minTextLen: 3,
            maxTextLen: 140,
            fadeIn: false,
            lazyload: "images/lazyload.gif",
            loadding: "images/loading.gif",
            islogin: "flase"
        },
        init: function (imgid) {
            var c;
            this.config = b.extend({},
            this.defaults, this.options);
            this.DOM = c = this._createDOM();
            this._setCss()._getJSON(imgid)._closeEvt();
            return this
        },
        _getJSON: function (imgid) {
            var c = this.DOM,
            d = this;
            b.getJSON(d.config.url+imgid,
            function (e) {
                if (typeof e != "undefined" && e.code > 0) {
                    d._data(e)
                } else {
                    alert(e.msg);
                    setTimeout(function () {
                        c.wrap.remove();
                        c.lock.remove();
                        delete a
                    },
                    1500)
                }
            }).error(function () {
                alert("\u83b7\u53d6\u6570\u636e\u51fa\u9519\uff0c\u8bf7\u5237\u65b0\u91cd\u8bd5");
                setTimeout(function () {
                    c.wrap.remove();
                    c.lock.remove();
                    delete a
                },
                1500)
            });
            return d
        },
        _data: function (g) {
            var e = this.DOM,
            h = this,
            d = g.thumbList,
            f = d.length,
            c = this._arrayKey(g.showimages, d);
            this.thumbList = g.thumbList;
            this.len = f;
            this.index = c;
            this._setData(d[c])._creaetList(d)._thumbEvent(c)._arrow(d, c)._arrowThumbLeft()._arrowThumbRight()._commentEvent()._resize(f);
            return this
        },
        _setData: function (d) {
            var c = this.DOM,
            e = this;
            c.img.hide();
            c.photo.css("background", "url(" + this.config.loadding + ") no-repeat center center");
            this._loadImage(d.large,
            function () {
                c.photo.css("background", "none");
                c.img.attr("src", d.large)[e.config.fadeIn === true ? "fadeIn" : "show"]();
                if (e.IE6) {
                    e.image = arguments[0];
                    e._IEImage(arguments[0])
                }
            });
            c.avatar.attr("src", d.avatar);
            c.userName.text(d.user);
            c.time.text(d.time);
            c.description.text(d.desc);
            c.count.text((parseInt(this.index) + 1) + " / " + this.len);
            c.title.text(d.title);
            c.pictureid.val(d.id);
            e._createComment(d.comment);
            return e
        },
        _creaetList: function (c) {
            var h = this,
            g = this.DOM,
            f = 0,
            e = "",
            d = c.length;
            for (; f < d; f++) {
                e += a.li.replace("{src}", c[f].thumb).replace("{index}", f).replace("{lazyload}", this.config.lazyload)
            }
            g.list.children("div").append('<ul class="ui-clearfix">' + e + "</ul>");
            g.list.children("div").children("ul").delegate("li", "click",
            function () {
                h.index = b(this).attr("data-index");
                g.list.find("ul").find("a").removeClass("current");
                b(this).children("a").addClass("current");
                h._setData(c[h.index])
            });
            return h
        },
        _createComment: function (c, g) {
            var e = "",
            h = this.DOM,
            d = c.length,
            f = 0;
            if (this._isArray(c)) {
                for (f; f < d; f++) {
                    e += a.comment.replace("{avatar}", c[f].avatar).replace("{user}", c[f].user).replace("{msg}", c[f].msg)
                }
            }
            h.commentlist[g == "add" ? "append" : "html"](e);
            return this
        },
        _thumbEvent: function (c) {
            var e = this.DOM;
            this.ulElem = e.list.find("ul");
            this.liWidth = this.ulElem.children("li").width();
            this.listWidth = e.list.children("div").width();
            this.thumbNum = parseInt(this.listWidth / (this.liWidth + this.config.fix));
            var d = (this.liWidth + this.config.fix) * this.len;
            if (this.listWidth >= d) {
                this.ulElem.css({
                    width: d,
                    margin: "0px auto"
                });
                e.list.children("a").hide()
            } else {
                e.list.children("a").show();
                this.ulElem.width(d);
                this._moveX(c)
            }
            this._lazyload();
            this.ulElem.children("li").eq(c).children("a").addClass("current");
            return this
        },
        _arrow: function (f, h) {
            var m = this.DOM,
            g = this,
            k = f.length,
            c = this.ulElem,
            e = (this.liWidth + this.config.fix) * this.len,
            j = c.children("li");
            if (this.len === 1) {
                m.arrowLeft.hide();
                m.arrowRight.hide()
            } else {
                var i = function (n) {
                    var o = n + 1,
                    p = n - 1;
                    if (n >= 0 && n < k - 1) {
                        g._loadImage(f[o].large)
                    }
                    if (n > 0 && n < k - 1) {
                        g._loadImage(f[p].large)
                    }
                };
                i(h);
                var l = function (n) {
                    if (n < 0) {
                        g.index = 0
                    }
                    if (n >= k) {
                        g.index = (k - 1)
                    }
                    if (n >= 0 && n < k) {
                        g._setData(f[g.index])
                    }
                    j.find("a").removeClass("current");
                    j.eq(g.index).children("a").addClass("current");
                    if (g.listWidth < e) {
                        g._moveX(g.index)
                    }
                };
                var d = function (n) {
                    l(n);
                    i(g.index);
                    g._lazyload()
                };
                m.arrowLeft.bind("click",
                function () {
                    d(--g.index)
                });
                m.arrowRight.bind("click",
                function () {
                    d(++g.index)
                });
                b(document).keydown(function (n) {
                    if (n.which == 37) {
                        d(--g.index)
                    }
                    if (n.which == 39) {
                        d(++g.index)
                    }
                })
            }
            return g
        },
        _arrowThumbLeft: function () {
            var c = this.DOM,
            d = this;
            change = this._getChange(),
            ulElem = this.ulElem;
            c.thumbLeft.bind("click",
            function () {
                var e = Math.abs(parseInt(ulElem.css("margin-left"))),
                f = 0;
                if (e <= 0) {
                    f = 0
                } else {
                    if ((e - change) >= change) {
                        f = e - change
                    } else {
                        f = 0
                    }
                }
                ulElem.stop(false, true).animate({
                    "margin-left": -f
                });
                d._lazyload(f)
            });
            return this
        },
        _arrowThumbRight: function () {
            var c = this.DOM,
            d = this;
            change = this._getChange(),
            ulElem = this.ulElem,
            ulWidth = (this.liWidth + this.config.fix) * this.len;
            c.thumbRight.bind("click",
            function () {
                var e = Math.abs(parseInt(ulElem.css("margin-left"))),
                f = 0;
                if (e <= 0) {
                    f = change
                } else {
                    if ((ulWidth - e) > change) {
                        f = change + e
                    } else {
                        f = e
                    }
                }
                ulElem.stop(false, true).animate({
                    "margin-left": -f
                });
                d._lazyload(f)
            });
            return this
        },
        _commentEvent: function () {
            var d = this,
            c = this.DOM;
            c.msg.bind("focus",
            function () {
                c.msgInfo.removeClass("error").text("").hide()
            });
            c.submit.bind("click",
            function () {

                if (d.config.islogin == 'true') {
                    if (c.msg.val().length < d.config.minTextLen || c.msg.val().length > d.config.maxTextLen) {
                        c.msgInfo.addClass("error").text("\u7559\u8a00\u5185\u5bb9\u4e0d\u5f97\u5c11\u4e8e" + d.config.minTextLen + "\u4e2a\u5b57\u7b26\uff0c\u6700\u591a\u4e0d\u80fd\u591a\u4e8e" + d.config.maxTextLen + "\u4e2a\u5b57\u7b26\u3002").show()
                    } else {
                        b(document).ajaxStart(function () {
                            c.submit.addClass("disabled").attr("disabled", true)
                        });
                        b.ajax({
                            url: d.config.commentURL,
                            type: "POST",
                            dataType: "JSON",
                            data: {
                                pictureid: c.pictureid.val(),
                                msg: c.msg.val()
                            },
                            success: function (e) {
                                if (typeof e !== "undefined" && e.code > 0) {
                                    c.msg.val("");
                                    c.msgInfo.removeClass("error").text(e.msg).show();
                                    d.thumbList[d.index].comment.push(e.comment[0]);
                                    d._createComment(e.comment, "add")
                                } else {
                                    c.msgInfo.addClass("error").text(dta.msg).show()
                                }
                                c.submit.removeClass("disabled").attr("disabled", false)
                            },
                            error: function () {
                                c.msgInfo.addClass("error").text("\u63d0\u4ea4\u53d1\u9001\u9519\u8bef\uff0c\u8bf7\u5237\u65b0\u540e\u91cd\u8bd5\u3002").show()
                            }
                        })
                    }
                } else {
                    c.msgInfo.addClass("error").text("\u8bf7\u5148\u767b\u5f55").show()
                }
            });
            return d
        },
        _resize: function (c) {
            var d = this.DOM,
            e = this;
            b(window).bind("resize",
            function () {
                d.photo.css("height", (d.primary.height() - 75));
                d.lock.css("height", b(document).height());
                d.thumbLeft.unbind();
                d.thumbRight.unbind();
                e._thumbEvent(e.index)._arrowThumbLeft()._arrowThumbRight();
                if (e.IE6) {
                    e._IE()._IEImage(e.image)
                }
            });
            return this
        },
        _arrayKey: function (f, c) {
            var e = 0,
            d = c.length;
            for (; e < d; e++) {
                if (c[e].id == f) {
                    return e
                }
            }
        },
        _isArray: function (c) {
            return (b.isArray(c) && c.length > 0) ? true : false
        },
        _loadImage: function (d, f) {
            var e = new Image(),
            c = [];
            e.src = d;
            if (e.complete) {
                c.push(e.width);
                c.push(e.height);
                if (typeof f !== "undefined") {
                    f.call(this, c)
                }
                return
            }
            e.onload = function () {
                c.push(e.width);
                c.push(e.height);
                if (typeof f !== "undefined") {
                    f.call(this, c)
                }
            }
        },
        _lazyload: function () {
            var f = this.DOM,
            e = this.ulElem.find("img"),
            c,
            i,
            d;
            if (typeof arguments[0] !== "undefined") {
                c = arguments[0]
            } else {
                c = parseInt(this.index / this.thumbNum) * this._getChange()
            }
            i = c / (this.liWidth + this.config.fix),
            d = (i + this.thumbNum + 1 > this.len) ? this.len : (i + this.thumbNum + 1);
            for (; i < d; i++) {
                var g = e.eq(i).attr("src"),
                h = e.eq(i).attr("data-src");
                if (g != h) {
                    e[i].src = h
                }
            }
            return this
        },
        _getChange: function () {
            return this.thumbNum * (this.liWidth + this.config.fix)
        },
        _moveX: function (d) {
            var e = this._getChange(),
            c = -parseInt(d / this.thumbNum) * e;
            this.ulElem.stop(false, true).animate({
                "margin-left": c
            })
        },
        _IEImage: function (d) {
            var g = this.DOM,
            f = b(window).width() - 200 - 300 - 20,
            h = b(window).height() - 100 - 60 - 20;
            if (d[0] > f) {
                var c = (f * d[1]) / d[0];
                g.img.width(f);
                g.img.height(c)
            } else {
                if (d[1] > h) {
                    var e = (h * d[0]) / d[1];
                    g.img.width(e);
                    g.img.height(h)
                } else {
                    g.img.width(f);
                    g.img.height(h)
                }
            }
            return this
        },
        _IE: function () {
            var f = this.DOM,
            e = b(window).width() - 200,
            d = b(window).height() - 100,
            c = e - 300;
            f.wrap.css({
                width: e,
                height: d,
                right: "auto",
                bottom: "auto"
            });
            f.primary.width(c).height(d);
            f.photo.width(c - 20).height(d - 60 - 20);
            f.arrowLeft.width(c / 2);
            f.arrowRight.width(c / 2);
            f.list.width(c).children("div").width(c - 60);
            f.sidebar.height(d);
            return this
        },
        _setCss: function () {
            var c = this.DOM,
            e = 9999,
            d = b(document).height();
            c.wrap.css("z-index", e);
            if (this.IE6) {
                this._IE()
            }
            c.lock.css({
                position: "absolute",
                top: "0px",
                left: "0px",
                width: "100%",
                height: d,
                opacity: 0.7,
                background: "#000",
                "z-index": --e
            });
            c.photo.css("height", (c.primary.height() - 75));
            return this
        },
        _createDOM: function () {
            var d = document.createElement("div");
            d.innerHTML = a.templates;
            d.className = "ui-dialog-wrap";
            document.body.appendChild(d);
            b("body").append('<div id="ui-dialog-lock"></div>');
            var g = {
                wrap: b(d),
                lock: b("#ui-dialog-lock")
            },
            e = 0,
            f = d.getElementsByTagName("*");
            elemLen = f.length;
            for (; e < elemLen; e++) {
                var c = f[e].className.replace("ui-dialog-", "");
                if (c) {
                    g[c] = b(f[e])
                }
            }
            return g
        },
        _closeEvt: function () {
            var c = this.DOM;
            var d = function () {
                c.wrap.remove();
                c.lock.remove();
                delete a
            };
            c.close.bind("click", d);
            c.lock.bind("click", d);
            return this
        }
    };
    a.templates = '<div class="ui-dialog-primary"><div class="ui-dialog-photo"><span></span><img class="ui-dialog-img" /><a class="ui-dialog-arrowLeft" href="javascript:void(0);;"><em></em></a><a class="ui-dialog-arrowRight" href="javascript:void(0);;"><em></em></a><div class="ui-dialog-album"><em class="ui-dialog-count"></em><div class="ui-dialog-title"></div></div></div><div class="ui-dialog-list"><a href="javascript:void(0);" class="ui-dialog-thumbLeft"><span></span></a><a href="javascript:void(0);" class="ui-dialog-thumbRight"><span></span></a><div></div></div></div><div class="ui-dialog-sidebar"><div class="ui-dialog-info ui-clearfix"><img class="ui-dialog-avatar" width="50" height="50" /><div class="ui-dialog-details"><h3 class="ui-dialog-userName"></h3><p class="ui-dialog-time"></p></div><div class="ui-dialog-description"></div></div><div class="ui-dialog-form"><textarea name="content" placeholder="\u8bf4\u70b9\u4ec0\u4e48\u5427\u002e\u002e\u002e" class="ui-dialog-msg"></textarea><input type="hidden" class="ui-dialog-pictureid" name="pictureid" value="" /><p class="ui-dialog-msgInfo"></p><input type="submit" value="\u53d1\u8868" class="ui-dialog-submit" /></div><div><ul class="ui-dialog-commentlist"></ul></div></div><div class="ui-dialog-close"><a href="javascript:;"></a></div>';
    a.li = '<li data-index="{index}"><a href="javascript:void(0);"><img data-src="{src}" src="{lazyload}" width="50" height="50" /></a></li>';
    a.comment = '<li><img class="thumb" src="{avatar}" width="30" height="30" /><div class="comment-body"><strong class="user-name">{user}</strong><p class="user-text">{msg}</p></div></li>';
    b.fn.QQPhoto = function (c) {
        return this.each(function () {
            new a(this, c)
        })
    };
    return b
}(jQuery));